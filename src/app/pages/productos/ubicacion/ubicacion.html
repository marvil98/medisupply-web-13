<app-page-header [pageTitle]="pageTitle" [backRoute]="'/productos'"></app-page-header>

<section class="content">
  <h2 class="title">{{ 'productLocationTitle' | translate }}</h2>

  <app-status-message
    *ngIf="message"
    [type]="message.type"
    [messageKey]="message.key"
    [float]="true">
  </app-status-message>

  <!-- Barra de búsqueda -->
  <div class="search-section">
    <mat-form-field appearance="outline" class="search-field">
      <mat-label>{{ 'searchProductLabel' | translate }}</mat-label>
      <input 
        matInput 
        [(ngModel)]="searchQuery"
        (keyup.enter)="onSearch()"
        [placeholder]="'searchProductPlaceholder' | translate">
      <mat-icon matSuffix (click)="onSearch()" class="search-icon">search</mat-icon>
    </mat-form-field>
  </div>

  <!-- Filtros -->
  <div class="filters-section">
    <div class="filter-row">
      <app-custom-select
        [labelKey]="'cityLabel'"
        [placeholderKey]="'cityPlaceholder'"
        [options]="cityOptions"
        [model]="selectedCity"
        (modelChange)="onCityChange()"
        name="city">
      </app-custom-select>

      <app-custom-select
        [labelKey]="'warehouseLabel'"
        [placeholderKey]="'warehousePlaceholder'"
        [options]="warehouseOptions"
        [model]="selectedWarehouse"
        (modelChange)="onWarehouseChange()"
        name="warehouse">
      </app-custom-select>
    </div>
  </div>

  <!-- Resultados -->
  <div class="results-section" *ngIf="filteredProducts.length > 0">
    <div class="products-grid">
      <mat-card *ngFor="let product of filteredProducts" class="product-card">
        <mat-card-header>
          <div mat-card-avatar class="product-image">
            <img [src]="product.image" [alt]="product.name" *ngIf="product.image">
            <mat-icon *ngIf="!product.image">inventory</mat-icon>
          </div>
          <mat-card-title>{{ product.name }}</mat-card-title>
          <mat-card-subtitle>{{ product.sku }}</mat-card-subtitle>
        </mat-card-header>
        
        <mat-card-content>
          <div class="availability-info">
            <span 
              class="availability-badge"
              [class.available]="product.hasAvailability"
              [class.unavailable]="!product.hasAvailability">
              <mat-icon>{{ product.hasAvailability ? 'check_circle' : 'cancel' }}</mat-icon>
              <span *ngIf="product.hasAvailability">
                {{ 'totalAvailable' | translate }}: {{ product.totalAvailable }}
              </span>
              <span *ngIf="!product.hasAvailability">
                {{ 'noAvailability' | translate }}
              </span>
            </span>
          </div>
        </mat-card-content>
        
        <mat-card-actions>
          <button 
            mat-flat-button 
            color="primary" 
            (click)="onViewLocations(product)"
            [disabled]="!product.hasAvailability">
            <mat-icon>location_on</mat-icon>
            {{ 'viewLocations' | translate }}
          </button>
        </mat-card-actions>
      </mat-card>
    </div>

    <!-- Paginación -->
    <mat-paginator
      *ngIf="totalProducts > pageSize"
      [length]="totalProducts"
      [pageSize]="pageSize"
      [pageIndex]="currentPage"
      (page)="onPageChange($event)"
      [pageSizeOptions]="[10, 20, 50]">
    </mat-paginator>
  </div>

  <!-- Estados vacíos -->
  <div class="empty-state" *ngIf="!loading && filteredProducts.length === 0 && searchQuery">
    <mat-icon class="empty-icon">inventory_2</mat-icon>
    <h3>{{ 'noProductsFound' | translate }}</h3>
    <p>{{ 'noProductsMessage' | translate }}</p>
  </div>

  <div class="empty-state" *ngIf="!loading && filteredProducts.length === 0 && !searchQuery">
    <mat-icon class="empty-icon">search</mat-icon>
    <h3>{{ 'searchProductsTitle' | translate }}</h3>
    <p>{{ 'searchProductsMessage' | translate }}</p>
  </div>

  <!-- Loading -->
  <div class="loading-state" *ngIf="loading">
    <mat-spinner></mat-spinner>
    <p>{{ 'loadingProducts' | translate }}</p>
  </div>
</section>

<!-- Popup de ubicaciones -->
<div class="popup-overlay" *ngIf="showLocationPopup" (click)="closeLocationPopup()">
  <div class="popup-content" (click)="$event.stopPropagation()" *ngIf="selectedProduct">
    <div class="popup-header">
      <h3 class="popup-title">{{ getCityName(selectedProduct.city) }} > {{ getWarehouseName(selectedProduct.warehouse) }}</h3>
      <button class="close-button" (click)="closeLocationPopup()">
        <mat-icon>close</mat-icon>
      </button>
    </div>
    
    <div class="popup-body">
      <div class="product-info">
        <h4 class="product-name">{{ selectedProduct.name }}</h4>
        <p class="product-sku">SKU {{ selectedProduct.sku }} • Total: {{ selectedProduct.totalAvailable }}</p>
      </div>
      
      <div class="location-details" *ngIf="selectedProduct.locations && selectedProduct.locations.length > 0">
        <h5 class="location-title">Ubicación Física</h5>
        <div class="location-grid">
          <div class="location-item">
            <span class="location-label">Sección</span>
            <span class="location-value">{{ selectedProduct.locations[0].section }}</span>
          </div>
          <div class="location-item">
            <span class="location-label">Pasillo</span>
            <span class="location-value">{{ selectedProduct.locations[0].aisle }}</span>
          </div>
          <div class="location-item">
            <span class="location-label">Mueble</span>
            <span class="location-value">{{ selectedProduct.locations[0].shelf }}</span>
          </div>
          <div class="location-item">
            <span class="location-label">Nivel</span>
            <span class="location-value">{{ selectedProduct.locations[0].level }}</span>
          </div>
        </div>
      </div>
      
      <div class="lots-section" *ngIf="selectedProduct.locations && selectedProduct.locations.length > 0">
        <h5 class="lots-title">Detalle de Lotes</h5>
        <div class="lots-table">
          <div class="table-header">
            <span>Lote</span>
            <span>Vence</span>
            <span>Disponible</span>
            <span>Reservada</span>
          </div>
          <div class="table-row" *ngFor="let location of selectedProduct.locations">
            <span class="lot-number">{{ location.lot }}</span>
            <span class="expiry-date">{{ formatDate(location.expires) }}</span>
            <span class="available-qty">{{ location.available }}</span>
            <span class="reserved-qty">{{ location.reserved }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
