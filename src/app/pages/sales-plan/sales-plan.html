<app-page-header 
  [pageTitle]="pageTitle" 
  [backRoute]="backRoute">
</app-page-header>

<div class="sales-plan-container">
  <div class="form-container">
    <form [formGroup]="salesPlanForm" (ngSubmit)="createSalesPlan()">
      
      <!-- Selector de Producto -->
      <div class="product-selector-section">
        <label class="product-label">{{ 'product_label' | translate }}</label>
        <div class="product-selector-container" (click)="toggleProductSelector()">
          <span class="selector-text">
            {{ getSelectedProductsText() }}
          </span>
          <mat-icon class="selector-icon">{{ isProductSelectorOpen ? 'keyboard_arrow_up' : 'keyboard_arrow_down' }}</mat-icon>
        </div>
        
        <!-- Grid de Productos -->
        <div class="products-grid" *ngIf="isProductSelectorOpen">
          <div class="product-card" 
               *ngFor="let product of products" 
               (click)="selectProduct(product)"
               [class.selected]="isProductSelected(product)">
            
            <!-- Indicador de selección -->
            <div class="selection-indicator" *ngIf="isProductSelected(product)">
              <mat-icon>check_circle</mat-icon>
            </div>
            
            <!-- Columna 1: Imagen -->
            <div class="product-image">
              <img 
                [src]="getProductImage(product)" 
                [alt]="product.name"
                (error)="onImageError($event, product)"
                class="product-img">
            </div>
            
            <!-- Columna 2: Detalles del producto -->
            <div class="product-details">
              <div class="product-name">{{ product.name }}</div>
              <div class="product-price">${{ product.price }}</div>
            </div>
            
            <!-- Columna 3: Botón Meta -->
            <button class="meta-button" 
                    (click)="setProductGoal(product, $event)"
                    [disabled]="!isProductSelected(product)">
              {{ 'goal_button' | translate }}
            </button>
          </div>
        </div>
      </div>

      <!-- Selector de Región -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>{{ 'region_label' | translate }}</mat-label>
        <mat-select 
          formControlName="region" 
          (blur)="validateField('region')"
          required>
          <mat-option 
            *ngFor="let region of regionOptions" 
            [value]="region.value">
            {{ region.labelKey | translate }}
          </mat-option>
        </mat-select>
        <mat-error *ngIf="getErrorMessage('region')">
          {{ getErrorMessage('region') }}
        </mat-error>
      </mat-form-field>

      <!-- Selector de Período -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>{{ 'period_label' | translate }}</mat-label>
        <mat-select 
          formControlName="quarter" 
          (blur)="validateField('quarter')"
          required>
          <mat-option 
            *ngFor="let quarter of quarterOptions" 
            [value]="quarter.value">
            {{ quarter.labelKey | translate }}
          </mat-option>
        </mat-select>
        <mat-error *ngIf="getErrorMessage('quarter')">
          {{ getErrorMessage('quarter') }}
        </mat-error>
      </mat-form-field>

      <!-- Campo Meta -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>{{ 'goal_label' | translate }}</mat-label>
        <input 
          matInput 
          type="text" 
          formControlName="totalGoal"
          (input)="onTotalGoalChange($event.target.value)"
          (blur)="validateField('totalGoal')"
          placeholder="$1.000.000"
          required>
        <mat-error *ngIf="getErrorMessage('totalGoal')">
          {{ getErrorMessage('totalGoal') }}
        </mat-error>
      </mat-form-field>

      <!-- Botón Crear Plan -->
      <div class="action-buttons">
        <button 
          mat-raised-button 
          type="submit"
          [disabled]="!isFormValid() || saveStatus() === 'saving'"
          class="create-button">
          {{ 'create_plan_button' | translate }}
        </button>
      </div>

      <!-- Mensajes de Estado -->
      <div class="status-messages" *ngIf="saveStatus() !== 'idle'">
        <div *ngIf="saveStatus() === 'saving'" class="saving-message">
          <mat-icon>hourglass_empty</mat-icon>
          {{ 'saving_plan' | translate }}
        </div>
        
        <div *ngIf="saveStatus() === 'success'" class="success-message">
          <mat-icon>check_circle</mat-icon>
          {{ 'plan_created_success' | translate }}
        </div>
        
        <div *ngIf="saveStatus() === 'error'" class="error-message">
          <mat-icon>error</mat-icon>
          {{ 'plan_creation_error' | translate }}
        </div>
      </div>
    </form>
  </div>
</div>
